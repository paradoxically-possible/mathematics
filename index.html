<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Quiz - Enhanced</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Modern CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --success-color: #4caf50;
            --background-color: #f7f9fc;
            --card-color: #ffffff;
            --text-color: #333333;
            --text-light: #666666;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --container-width: 800px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-md);
        }

        .container {
            width: 100%;
            max-width: var(--container-width);
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: var(--spacing-lg);
            position: relative;
        }

        header h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 600;
        }

        /* Custom moon emoji style for the header */
        .moon-icon {
            font-size: 1.5rem;
            margin-left: var(--spacing-sm);
            vertical-align: middle;
        }

        /* Settings Panel Styles */
        #settings-panel {
            padding: var(--spacing-lg);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .settings-section {
            margin-bottom: var(--spacing-lg);
        }

        .settings-section h3 {
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
            font-weight: 500;
        }

        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: var(--spacing-sm);
            cursor: pointer;
        }

        .timer-settings {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background-color: rgba(79, 195, 247, 0.1);
            border-radius: var(--border-radius);
            border: 1px solid rgba(79, 195, 247, 0.3);
        }

        .input-group {
            margin-bottom: var(--spacing-md);
        }

        .input-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .input-group input[type="number"],
        .input-group input[type="range"] {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .input-group input[type="number"]:focus,
        .input-group input[type="range"]:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }

        .slider-container {
            display: flex;
            align-items: center;
        }

        .slider-container input[type="range"] {
            flex: 1;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            margin-left: var(--spacing-md);
            font-weight: 600;
        }

        .btn {
            display: inline-block;
            padding: var(--spacing-sm) var(--spacing-lg);
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            text-align: center;
            font-size: 1rem;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-large {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 1.1rem;
            width: 100%;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        /* Quiz Interface Styles */
        #quiz-interface {
            padding: var(--spacing-lg);
        }

        .timer-bar-container {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
        }

        .timer-bar {
            height: 100%;
            background-color: var(--accent-color);
            border-radius: 5px;
            transition: width 1s linear;
        }

        .timer-bar.warning {
            background-color: var(--warning-color);
        }

        .timer-bar.danger {
            background-color: var(--danger-color);
        }

        .timer-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            font-weight: 600;
        }

        .question-container {
            background-color: rgba(74, 111, 165, 0.05);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .question {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }

        .answer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
        }

        .answer-input {
            width: 100%;
            max-width: 200px;
            padding: var(--spacing-md);
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .answer-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 195, 247, 0.2);
        }

        .division-result {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
        }

        .division-result .input-group {
            margin-bottom: 0;
        }

        .progress-info {
            margin-top: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            color: var(--text-light);
        }

        /* Results Panel Styles */
        #results-panel {
            padding: var(--spacing-lg);
        }

        .results-header {
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: confetti-fall 3s ease-in-out infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .results-summary {
            background-color: rgba(76, 175, 80, 0.1);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            text-align: center;
        }

        .score-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--success-color);
            margin-bottom: var(--spacing-sm);
        }

        .chart-container {
            margin: var(--spacing-lg) 0;
            height: 300px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .adaptive-feedback {
            background-color: rgba(79, 195, 247, 0.1);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .feedback-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .feedback-icon {
            font-size: 1.5rem;
            margin-right: var(--spacing-sm);
            color: var(--accent-color);
        }

        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .action-buttons .btn {
            flex: 1;
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% {
                transform: translate3d(-1px, 0, 0);
            }
            20%, 80% {
                transform: translate3d(2px, 0, 0);
            }
            30%, 50%, 70% {
                transform: translate3d(-4px, 0, 0);
            }
            40%, 60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .settings-grid,
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 0 var(--spacing-sm);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .question {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Math Quiz <span class="moon-icon">🌙</span></h1>
        </header>
        
        <!-- Settings Panel -->
        <section id="settings-panel">
            <div class="settings-grid">
                <div class="settings-section">
                    <h3>Select Operations</h3>
                    <div class="checkbox-container">
                        <div class="checkbox-item">
                            <input type="checkbox" id="addition" checked>
                            <label for="addition">Addition</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="subtraction">
                            <label for="subtraction">Subtraction</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="multiplication">
                            <label for="multiplication">Multiplication</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="division">
                            <label for="division">Division</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="exponentiation">
                            <label for="exponentiation">Exponentiation</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="percentage">
                            <label for="percentage">Percentage</label>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Number Range</h3>
                    <div class="input-group">
                        <label for="leftNumberLimit">Left Number Limit (0 to ...):</label>
                        <input type="number" id="leftNumberLimit" min="1" max="1000" value="10">
                    </div>
                    <div class="input-group">
                        <label for="rightNumberLimit">Right Number Limit (0 to ...):</label>
                        <input type="number" id="rightNumberLimit" min="1" max="1000" value="10">
                    </div>
                    <div class="input-group">
                        <label for="exponentValue">Exponent Value:</label>
                        <input type="number" id="exponentValue" min="1" max="10" value="2">
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="checkbox-item">
                    <input type="checkbox" id="timerEnabled">
                    <label for="timerEnabled">Enable Timer Challenge Mode</label>
                </div>
                
                <div id="timerSettings" class="timer-settings hidden">
                    <div class="input-group">
                        <label for="timerDuration">Time per Question (seconds):</label>
                        <div class="slider-container">
                            <input type="range" id="timerDuration" min="5" max="60" value="30" step="5">
                            <span class="slider-value" id="timerDurationValue">30</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-group">
                <label for="questionCount">Number of Questions:</label>
                <input type="number" id="questionCount" min="1" max="50" value="10">
            </div>
            
            <button id="startQuizBtn" class="btn btn-large btn-success">Start Quiz</button>
        </section>
        
        <!-- Quiz Interface -->
        <section id="quiz-interface" class="hidden">
            <div id="timerContainer" class="hidden">
                <div class="timer-info">
                    <span id="timeLeft">30s left</span>
                    <span id="questionProgress">Question 1 of 10</span>
                </div>
                <div class="timer-bar-container">
                    <div id="timerBar" class="timer-bar" style="width: 100%;"></div>
                </div>
            </div>
            
            <div class="question-container">
                <div class="question" id="question">8 + 5 = ?</div>
            </div>
            
            <div class="answer-container">
                <input type="number" id="answer" class="answer-input" placeholder="Your answer">
                
                <div id="divisionResults" class="division-result hidden">
                    <div class="input-group">
                        <label for="quotient">Quotient:</label>
                        <input type="number" id="quotient" class="answer-input">
                    </div>
                    <div class="input-group">
                        <label for="remainder">Remainder:</label>
                        <input type="number" id="remainder" class="answer-input">
                    </div>
                </div>
                
                <button id="submitAnswerBtn" class="btn btn-large">Submit Answer</button>
            </div>
            
            <div class="progress-info">
                <span id="currentScoreDisplay">Score: 0 / 0</span>
            </div>
        </section>
        
        <!-- Results Panel -->
        <section id="results-panel" class="hidden">
            <div class="results-header">
                <h2>Congratulations! 🥳</h2>
                <p>You've completed the quiz!</p>
            </div>
            
            <div class="results-summary">
                <div class="score-display" id="finalScore">8 / 10</div>
                <p>Correct Answers</p>
            </div>
            
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="avgTimeValue">6.2s</div>
                    <div class="stat-label">Average Time per Question</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="accuracyValue">80%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fastestTimeValue">2.8s</div>
                    <div class="stat-label">Fastest Answer</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="improvedByValue">+5%</div>
                    <div class="stat-label">Improved from Last Quiz</div>
                </div>
            </div>
            
            <div class="adaptive-feedback">
                <div class="feedback-header">
                    <i class="fas fa-robot feedback-icon"></i>
                    <h3>Adaptive Learning Feedback</h3>
                </div>
                <p id="adaptiveFeedback">
                    Based on your performance, you're doing well with addition problems but may need more practice with multiplication. 
                    Your next quiz will have slightly more challenging multiplication problems to help you improve.
                </p>
            </div>
            
            <div class="action-buttons">
                <button id="restartQuizBtn" class="btn">Start New Quiz</button>
                <button id="adaptiveQuizBtn" class="btn btn-success">Try Adaptive Quiz</button>
            </div>
        </section>
    </div>

    <script>
        // Store user data and quiz state
        const quizState = {
            operations: [],
            currentQuestion: 0,
            totalQuestions: 0,
            score: 0,
            timerEnabled: false,
            timerDuration: 30,
            timerInterval: null,
            startTime: 0,
            questions: [],
            answers: [],
            timeTaken: [],
            isCorrect: [],
            operationTypes: [],
            difficulty: 'normal', // 'easy', 'normal', 'hard'
        };

        // DOM Elements
        const settingsPanel = document.getElementById('settings-panel');
        const quizInterface = document.getElementById('quiz-interface');
        const resultsPanel = document.getElementById('results-panel');
        const startQuizBtn = document.getElementById('startQuizBtn');
        const submitAnswerBtn = document.getElementById('submitAnswerBtn');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        const adaptiveQuizBtn = document.getElementById('adaptiveQuizBtn');
        const timerEnabledCheckbox = document.getElementById('timerEnabled');
        const timerSettings = document.getElementById('timerSettings');
        const timerContainer = document.getElementById('timerContainer');
        const timerBar = document.getElementById('timerBar');
        const timeLeft = document.getElementById('timeLeft');
        const questionProgress = document.getElementById('questionProgress');
        const timerDurationSlider = document.getElementById('timerDuration');
        const timerDurationValue = document.getElementById('timerDurationValue');
        const questionElement = document.getElementById('question');
        const answerInput = document.getElementById('answer');
        const divisionResults = document.getElementById('divisionResults');
        const quotientInput = document.getElementById('quotient');
        const remainderInput = document.getElementById('remainder');
        const currentScoreDisplay = document.getElementById('currentScoreDisplay');
        const finalScore = document.getElementById('finalScore');
        const avgTimeValue = document.getElementById('avgTimeValue');
        const accuracyValue = document.getElementById('accuracyValue');
        const fastestTimeValue = document.getElementById('fastestTimeValue');
        const improvedByValue = document.getElementById('improvedByValue');
        const adaptiveFeedback = document.getElementById('adaptiveFeedback');

        // Operation checkbox references
        const operationCheckboxes = {
            addition: document.getElementById('addition'),
            subtraction: document.getElementById('subtraction'),
            multiplication: document.getElementById('multiplication'),
            division: document.getElementById('division'),
            exponentiation: document.getElementById('exponentiation'),
            percentage: document.getElementById('percentage')
        };

        // Initialize application
        function init() {
            // Set up event listeners
            timerEnabledCheckbox.addEventListener('change', toggleTimerSettings);
            timerDurationSlider.addEventListener('input', updateTimerDurationDisplay);
            startQuizBtn.addEventListener('click', startQuiz);
            submitAnswerBtn.addEventListener('click', checkAnswer);
            restartQuizBtn.addEventListener('click', resetQuiz);
            adaptiveQuizBtn.addEventListener('click', startAdaptiveQuiz);
            answerInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkAnswer();
            });
            
            // Load saved preferences if available
            loadUserPreferences();
            
            // Initial UI setup
            updateTimerDurationDisplay();
        }

        // Toggle timer settings visibility
        function toggleTimerSettings() {
            timerSettings.classList.toggle('hidden', !timerEnabledCheckbox.checked);
        }

        // Update timer duration display
        function updateTimerDurationDisplay() {
            timerDurationValue.textContent = timerDurationSlider.value;
        }

        // Load user preferences from localStorage
        function loadUserPreferences() {
            const savedPreferences = localStorage.getItem('mathQuizPreferences');
            if (savedPreferences) {
                const preferences = JSON.parse(savedPreferences);
                
                // Restore operation selections
                for (const op in operationCheckboxes) {
                    if (preferences.operations && preferences.operations[op] !== undefined) {
                        operationCheckboxes[op].checked = preferences.operations[op];
                    }
                }
                
                // Restore other settings
                if (preferences.leftNumberLimit) 
                    document.getElementById('leftNumberLimit').value = preferences.leftNumberLimit;
                if (preferences.rightNumberLimit) 
                    document.getElementById('rightNumberLimit').value = preferences.rightNumberLimit;
                if (preferences.exponentValue) 
                    document.getElementById('exponentValue').value = preferences.exponentValue;
                if (preferences.questionCount) 
                    document.getElementById('questionCount').value = preferences.questionCount;
                if (preferences.timerEnabled !== undefined) {
                    timerEnabledCheckbox.checked = preferences.timerEnabled;
                    toggleTimerSettings();
                }
                if (preferences.timerDuration) {
                    timerDurationSlider.value = preferences.timerDuration;
                    updateTimerDurationDisplay();
                }
            }
        }

        // Save user preferences to localStorage
        function saveUserPreferences() {
            const preferences = {
                operations: {},
                leftNumberLimit: parseInt(document.getElementById('leftNumberLimit').value),
                rightNumberLimit: parseInt(document.getElementById('rightNumberLimit').value),
                exponentValue: parseInt(document.getElementById('exponentValue').value),
                questionCount: parseInt(document.getElementById('questionCount').value),
                timerEnabled: timerEnabledCheckbox.checked,
                timerDuration: parseInt(timerDurationSlider.value)
            };
            
            // Save operation selections
            for (const op in operationCheckboxes) {
                preferences.operations[op] = operationCheckboxes[op].checked;
            }
            
            localStorage.setItem('mathQuizPreferences', JSON.stringify(preferences));
        }

        // Start the quiz
        function startQuiz() {
            // Get selected operations
            quizState.operations = [];
            for (const op in operationCheckboxes) {
                if (operationCheckboxes[op].checked) {
                    quizState.operations.push(op);
                }
            }
            
            // Validate selections
            if (quizState.operations.length === 0) {
                alert('Please select at least one operation type');
                return;
            }
            
            // Get quiz settings
            const leftNumberLimit = parseInt(document.getElementById('leftNumberLimit').value);
            const rightNumberLimit = parseInt(document.getElementById('rightNumberLimit').value);
            quizState.totalQuestions = parseInt(document.getElementById('questionCount').value);
            quizState.timerEnabled = timerEnabledCheckbox.checked;
            quizState.timerDuration = parseInt(timerDurationSlider.value);
            
            // Save preferences
            saveUserPreferences();
            
            // Generate questions
            generateQuestions(leftNumberLimit, rightNumberLimit);
            
            // Reset quiz state
            quizState.currentQuestion = 0;
            quizState.score = 0;
            quizState.answers = new Array(quizState.totalQuestions).fill(null);
            quizState.timeTaken = new Array(quizState.totalQuestions).fill(0);
            quizState.isCorrect = new Array(quizState.totalQuestions).fill(false);
            
            // Switch to quiz interface
            settingsPanel.classList.add('hidden');
            quizInterface.classList.remove('hidden');
            
            // Display first question
            displayQuestion();
            
            // Focus on answer input
            answerInput.focus();
        }

        // Generate questions for the quiz
        function generateQuestions(leftLimit, rightLimit) {
            const exponentValue = parseInt(document.getElementById('exponentValue').value);
            quizState.questions = [];
            quizState.operationTypes = [];
            
            for (let i = 0; i < quizState.totalQuestions; i++) {
                const operationType = quizState.operations[Math.floor(Math.random() * quizState.operations.length)];
                quizState.operationTypes.push(operationType);
                
                let leftNum, rightNum, question, answer;
                
                // Generate numbers based on difficulty (for adaptive quizzes)
                if (quizState.difficulty === 'easy') {
                    leftNum = Math.floor(Math.random() * (leftLimit / 2)) + 1;
                    rightNum = Math.floor(Math.random() * (rightLimit / 2)) + 1;
                } else if (quizState.difficulty === 'hard') {
                    leftNum = Math.floor(Math.random() * leftLimit) + leftLimit/2;
                    rightNum = Math.floor(Math.random() * rightLimit) + rightLimit/2;
                } else { // normal difficulty
                    leftNum = Math.floor(Math.random() * leftLimit) + 1;
                    rightNum = Math.floor(Math.random() * rightLimit) + 1;
                }
                
                // Special case for division to ensure clean division for beginners in easy mode
                if (operationType === 'division' && quizState.difficulty === 'easy') {
                    rightNum = Math.floor(Math.random() * 10) + 1;
                    leftNum = rightNum * (Math.floor(Math.random() * 10) + 1);
                }
                
                // Generate question and answer based on operation type
                switch (operationType) {
                    case 'addition':
                        question = `${leftNum} + ${rightNum} = ?`;
                        answer = leftNum + rightNum;
                        break;
                    case 'subtraction':
                        // Ensure leftNum is larger for beginners in easy mode
                        if (quizState.difficulty === 'easy') {
                            if (leftNum < rightNum) [leftNum, rightNum] = [rightNum, leftNum];
                        }
                        question = `${leftNum} - ${rightNum} = ?`;
                        answer = leftNum - rightNum;
                        break;
                    case 'multiplication':
                        question = `${leftNum} × ${rightNum} = ?`;
                        answer = leftNum * rightNum;
                        break;
                    case 'division':
                        if (rightNum === 0) rightNum = 1; // Avoid division by zero
                        question = `${leftNum} ÷ ${rightNum} = ?`;
                        // For division, we store an array with quotient and remainder
                        answer = [Math.floor(leftNum / rightNum), leftNum % rightNum];
                        break;
                    case 'exponentiation':
                        // Limit exponent size for usability
                        rightNum = Math.min(rightNum, exponentValue);
                        question = `${leftNum} ^ ${rightNum} = ?`;
                        answer = Math.pow(leftNum, rightNum);
                        break;
                    case 'percentage':
                        question = `${leftNum}% of ${rightNum} = ?`;
                        answer = (leftNum / 100) * rightNum;
                        break;
                }
                
                quizState.questions.push({
                    question,
                    answer,
                    operationType,
                    leftNum,
                    rightNum
                });
            }
        }

        // Display the current question
        function displayQuestion() {
            const currentQ = quizState.questions[quizState.currentQuestion];
            questionElement.textContent = currentQ.question;
            
            // Update progress display
            questionProgress.textContent = `Question ${quizState.currentQuestion + 1} of ${quizState.totalQuestions}`;
            currentScoreDisplay.textContent = `Score: ${quizState.score} / ${quizState.currentQuestion}`;
            
            // Show/hide division results inputs
            if (currentQ.operationType === 'division') {
                divisionResults.classList.remove('hidden');
                answerInput.classList.add('hidden');
                quotientInput.value = '';
                remainderInput.value = '';
                quotientInput.focus();
            } else {
                divisionResults.classList.add('hidden');
                answerInput.classList.remove('hidden');
                answerInput.value = '';
                answerInput.focus();
            }
            
            // Reset and start timer if enabled
            if (quizState.timerEnabled) {
                timerContainer.classList.remove('hidden');
                timerBar.style.width = '100%';
                timerBar.className = 'timer-bar';
                timeLeft.textContent = `${quizState.timerDuration}s left`;
                
                // Clear previous timer if exists
                if (quizState.timerInterval) {
                    clearInterval(quizState.timerInterval);
                }
                
                // Start new timer
                quizState.startTime = Date.now();
                startTimer();
            } else {
                timerContainer.classList.add('hidden');
                quizState.startTime = Date.now();
            }
        }

        // Start the timer for current question
        function startTimer() {
            let timeRemaining = quizState.timerDuration;
            
            quizState.timerInterval = setInterval(() => {
                timeRemaining -= 0.1; // Update every 100ms
                const percentage = (timeRemaining / quizState.timerDuration) * 100;
                
                // Update timer bar
                timerBar.style.width = `${percentage}%`;
                timeLeft.textContent = `${Math.ceil(timeRemaining)}s left`;
                
                // Add warning classes
                if (percentage <= 25) {
                    timerBar.className = 'timer-bar danger pulse';
                } else if (percentage <= 50) {
                    timerBar.className = 'timer-bar warning';
                }
                
                // Time's up
                if (timeRemaining <= 0) {
                    clearInterval(quizState.timerInterval);
                    handleTimeUp();
                }
            }, 100);
        }

        // Handle when time is up
        function handleTimeUp() {
            // Record time taken as max time
            quizState.timeTaken[quizState.currentQuestion] = quizState.timerDuration;
            
            // Move to next question
            moveToNextQuestion();
        }

        // Check the user's answer
        function checkAnswer() {
            const currentQ = quizState.questions[quizState.currentQuestion];
            let userAnswer, isCorrect = false;
            
            // Stop timer
            if (quizState.timerInterval) {
                clearInterval(quizState.timerInterval);
            }
            
            // Calculate time taken
            const timeTaken = (Date.now() - quizState.startTime) / 1000;
            quizState.timeTaken[quizState.currentQuestion] = Math.min(timeTaken, quizState.timerDuration);
            
            // Get and validate user's answer
            if (currentQ.operationType === 'division') {
                const quotient = parseInt(quotientInput.value);
                const remainder = parseInt(remainderInput.value);
                
                if (isNaN(quotient) || isNaN(remainder)) {
                    showAnswerError();
                    return;
                }
                
                userAnswer = [quotient, remainder];
                isCorrect = userAnswer[0] === currentQ.answer[0] && userAnswer[1] === currentQ.answer[1];
                quizState.answers[quizState.currentQuestion] = userAnswer;
            } else {
                userAnswer = parseFloat(answerInput.value);
                
                if (isNaN(userAnswer)) {
                    showAnswerError();
                    return;
                }
                
                // For percentage questions, allow a small margin of error due to rounding
                if (currentQ.operationType === 'percentage') {
                    isCorrect = Math.abs(userAnswer - currentQ.answer) < 0.01;
                } else {
                    isCorrect = userAnswer === currentQ.answer;
                }
                
                quizState.answers[quizState.currentQuestion] = userAnswer;
            }
            
            // Update score and record correctness
            if (isCorrect) {
                quizState.score++;
            }
            quizState.isCorrect[quizState.currentQuestion] = isCorrect;
            
            // Move to next question or show results
            moveToNextQuestion();
        }

        // Show error for invalid answer
        function showAnswerError() {
            // Shake the input for visual feedback
            if (quizState.questions[quizState.currentQuestion].operationType === 'division') {
                quotientInput.classList.add('shake');
                remainderInput.classList.add('shake');
                setTimeout(() => {
                    quotientInput.classList.remove('shake');
                    remainderInput.classList.remove('shake');
                }, 500);
            } else {
                answerInput.classList.add('shake');
                setTimeout(() => {
                    answerInput.classList.remove('shake');
                }, 500);
            }
        }

        // Move to the next question or finish the quiz
        function moveToNextQuestion() {
            quizState.currentQuestion++;
            
            if (quizState.currentQuestion < quizState.totalQuestions) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        // Show quiz results
        function showResults() {
            quizInterface.classList.add('hidden');
            resultsPanel.classList.remove('hidden');
            
            // Display final score
            finalScore.textContent = `${quizState.score} / ${quizState.totalQuestions}`;
            
            // Calculate statistics
            const avgTime = quizState.timeTaken.reduce((a, b) => a + b, 0) / quizState.totalQuestions;
            const fastestTime = Math.min(...quizState.timeTaken);
            const accuracy = (quizState.score / quizState.totalQuestions) * 100;
            
            // Display statistics
            avgTimeValue.textContent = `${avgTime.toFixed(1)}s`;
            fastestTimeValue.textContent = `${fastestTime.toFixed(1)}s`;
            accuracyValue.textContent = `${accuracy.toFixed(0)}%`;
            
            // Compare with previous results
            const prevResults = loadPreviousResults();
            let improvement = 0;
            
            if (prevResults && prevResults.length > 0) {
                const lastResult = prevResults[prevResults.length - 1];
                improvement = accuracy - lastResult.accuracy;
                improvedByValue.textContent = `${improvement > 0 ? '+' : ''}${improvement.toFixed(0)}%`;
            } else {
                improvedByValue.textContent = 'First Quiz';
            }
            
            // Save current results
            saveQuizResults({
                date: new Date().toISOString(),
                score: quizState.score,
                totalQuestions: quizState.totalQuestions,
                accuracy: accuracy,
                avgTime: avgTime,
                operations: quizState.operationTypes,
                isCorrect: quizState.isCorrect,
                timeTaken: quizState.timeTaken,
                difficulty: quizState.difficulty
            });
            
            // Generate adaptive feedback
            generateAdaptiveFeedback();
            
            // Create performance charts
            createPerformanceChart();
            
            // Create celebratory confetti effect
            if (quizState.score > quizState.totalQuestions / 2) {
                createConfetti();
            }
        }

        // Create confetti animation
        function createConfetti() {
            const container = document.querySelector('.container');
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722'];
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = `${Math.random() * 10 + 5}px`;
                confetti.style.opacity = Math.random() + 0.5;
                confetti.style.animationDelay = `${Math.random() * 3}s`;
                container.appendChild(confetti);
            }
            
            // Remove confetti after animation completes
            setTimeout(() => {
                const confettiElements = document.querySelectorAll('.confetti');
                confettiElements.forEach(el => el.remove());
            }, 6000);
        }

        // Create performance chart using Chart.js
        function createPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            // Prepare data for the chart
            const labels = [];
            const timeData = [];
            const correctnessData = [];
            
            for (let i = 0; i < quizState.totalQuestions; i++) {
                labels.push(`Q${i + 1}`);
                timeData.push(quizState.timeTaken[i]);
                correctnessData.push(quizState.isCorrect[i] ? 1 : 0);
            }
            
            // Create chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Time Taken (seconds)',
                            data: timeData,
                            backgroundColor: 'rgba(79, 195, 247, 0.5)',
                            borderColor: 'rgba(79, 195, 247, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Correct Answer',
                            data: correctnessData,
                            type: 'line',
                            backgroundColor: 'rgba(76, 175, 80, 0.5)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(76, 175, 80, 1)',
                            pointRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 1,
                            position: 'right',
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value === 1 ? 'Correct' : 'Incorrect';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate adaptive feedback based on performance
        function generateAdaptiveFeedback() {
            // Analyze performance by operation type
            const operationPerformance = {};
            const operationTime = {};
            
            for (let i = 0; i < quizState.totalQuestions; i++) {
                const opType = quizState.operationTypes[i];
                
                if (!operationPerformance[opType]) {
                    operationPerformance[opType] = {
                        correct: 0,
                        total: 0
                    };
                    operationTime[opType] = [];
                }
                
                operationPerformance[opType].total++;
                if (quizState.isCorrect[i]) {
                    operationPerformance[opType].correct++;
                }
                
                operationTime[opType].push(quizState.timeTaken[i]);
            }
            
            // Identify strengths and weaknesses
            const strengths = [];
            const weaknesses = [];
            
            for (const op in operationPerformance) {
                const perf = operationPerformance[op];
                const accuracy = (perf.correct / perf.total) * 100;
                const avgTime = operationTime[op].reduce((a, b) => a + b, 0) / operationTime[op].length;
                
                if (perf.total > 0) {
                    if (accuracy >= 80) {
                        strengths.push({ operation: getOperationName(op), accuracy, avgTime });
                    } else if (accuracy < 60) {
                        weaknesses.push({ operation: getOperationName(op), accuracy, avgTime });
                    }
                }
            }
            
            // Sort by accuracy
            strengths.sort((a, b) => b.accuracy - a.accuracy);
            weaknesses.sort((a, b) => a.accuracy - b.accuracy);
            
            // Generate feedback text
            let feedback = '';
            
            if (quizState.score === quizState.totalQuestions) {
                feedback = `Perfect score! Amazing job! You've mastered all the operations in this quiz level.`;
            } else if (quizState.score >= quizState.totalQuestions * 0.8) {
                feedback = `Great work! You're showing strong skills across most operations.`;
            } else if (quizState.score >= quizState.totalQuestions * 0.5) {
                feedback = `Good effort! With some targeted practice, you can improve your score even more.`;
            } else {
                feedback = `You're making progress! Let's focus on building your fundamental skills.`;
            }
            
            feedback += ' ';
            
            if (strengths.length > 0) {
                feedback += `You're particularly strong with ${strengths[0].operation}`;
                if (strengths.length > 1) {
                    feedback += ` and ${strengths[1].operation}`;
                }
                feedback += '. ';
            }
            
            if (weaknesses.length > 0) {
                feedback += `You might benefit from more practice with ${weaknesses[0].operation}`;
                if (weaknesses.length > 1) {
                    feedback += ` and ${weaknesses[1].operation}`;
                }
                feedback += '. ';
            }
            
            // Add adaptive difficulty recommendation
            const overallAccuracy = (quizState.score / quizState.totalQuestions) * 100;
            
            if (overallAccuracy >= 85) {
                feedback += `For your next quiz, we recommend trying a more challenging level to push your math skills further.`;
                quizState.recommendedDifficulty = 'hard';
            } else if (overallAccuracy <= 40) {
                feedback += `For your next quiz, we recommend starting with a slightly easier level to build up your skills and confidence.`;
                quizState.recommendedDifficulty = 'easy';
            } else {
                feedback += `Your current difficulty level seems appropriate. Keep practicing to improve your accuracy and speed.`;
                quizState.recommendedDifficulty = 'normal';
            }
            
            adaptiveFeedback.textContent = feedback;
        }

        // Get friendly name for operation type
        function getOperationName(operation) {
            const names = {
                'addition': 'addition',
                'subtraction': 'subtraction',
                'multiplication': 'multiplication',
                'division': 'division',
                'exponentiation': 'exponents',
                'percentage': 'percentages'
            };
            
            return names[operation] || operation;
        }

        // Load previous quiz results from localStorage
        function loadPreviousResults() {
            const savedResults = localStorage.getItem('mathQuizResults');
            return savedResults ? JSON.parse(savedResults) : [];
        }

        // Save quiz results to localStorage
        function saveQuizResults(results) {
            const previousResults = loadPreviousResults();
            previousResults.push(results);
            
            // Keep only the last 20 results to prevent localStorage from getting too large
            if (previousResults.length > 20) {
                previousResults.shift();
            }
            
            localStorage.setItem('mathQuizResults', JSON.stringify(previousResults));
        }

        // Start adaptive quiz based on previous performance
        function startAdaptiveQuiz() {
            // Set difficulty based on recommendation
            quizState.difficulty = quizState.recommendedDifficulty || 'normal';
            
            // Analyze previous results to determine which operations to focus on
            const previousResults = loadPreviousResults();
            
            if (previousResults.length > 0) {
                // Get operations with lowest accuracy from recent quizzes
                const operationAccuracy = {};
                let totalOperations = 0;
                
                // Consider only the most recent 3 quizzes
                const recentResults = previousResults.slice(-3);
                
                recentResults.forEach(result => {
                    for (let i = 0; i < result.operations.length; i++) {
                        const operation = result.operations[i];
                        if (!operationAccuracy[operation]) {
                            operationAccuracy[operation] = {
                                correct: 0,
                                total: 0
                            };
                        }
                        
                        operationAccuracy[operation].total++;
                        totalOperations++;
                        
                        if (result.isCorrect[i]) {
                            operationAccuracy[operation].correct++;
                        }
                    }
                });
                
                // Calculate accuracy percentages
                for (const op in operationAccuracy) {
                    operationAccuracy[op].accuracy = 
                        (operationAccuracy[op].correct / operationAccuracy[op].total) * 100;
                }
                
                // Sort operations by accuracy (lowest first)
                const sortedOperations = Object.keys(operationAccuracy).sort(
                    (a, b) => operationAccuracy[a].accuracy - operationAccuracy[b].accuracy
                );
                
                // Select operations to focus on (lower accuracy gets more weight)
                // Ensure at least 3 operations if available
                const selectedOps = new Set();
                
                // First add all operations with accuracy below 70%
                sortedOperations.forEach(op => {
                    if (operationAccuracy[op].accuracy < 70) {
                        selectedOps.add(op);
                    }
                });
                
                // Then add remaining operations if we have less than 3
                let i = 0;
                while (selectedOps.size < 3 && i < sortedOperations.length) {
                    selectedOps.add(sortedOperations[i]);
                    i++;
                }
                
                // Check all operation checkboxes that should be included
                for (const op in operationCheckboxes) {
                    operationCheckboxes[op].checked = selectedOps.has(op);
                }
                
                // If none were selected (e.g., no previous data for that operation), default to all
                if (selectedOps.size === 0) {
                    for (const op in operationCheckboxes) {
                        operationCheckboxes[op].checked = true;
                    }
                }
            }
            
            // Reset UI and return to settings
            resetQuiz();
        }

        // Reset quiz to beginning
        function resetQuiz() {
            // Clear any timers
            if (quizState.timerInterval) {
                clearInterval(quizState.timerInterval);
            }
            
            // Reset UI
            resultsPanel.classList.add('hidden');
            quizInterface.classList.add('hidden');
            settingsPanel.classList.remove('hidden');
            
            // Clear confetti
            const confettiElements = document.querySelectorAll('.confetti');
            confettiElements.forEach(el => el.remove());
            
            // Reset state
            quizState.difficulty = 'normal';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
